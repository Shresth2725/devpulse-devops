- hosts: web
  become: yes

  tasks:
    - name: Ensure backend directory exists
      file:
        path: /home/ubuntu/backend
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"

    - name: Pull latest backend code
      become: false
      git:
        repo: https://github.com/Shresth2725/DevPulse.git
        dest: /home/ubuntu/backend
        version: main
        update: yes
        force: yes

    - name: Create .env file for backend
      become: false
      copy:
        dest: /home/ubuntu/backend/.env
        content: |
          DB_CONNECTION_STRING={{ lookup('env', 'DB_CONNECTION_STRING') }}
          JWT_SECRET_KEY={{ lookup('env', 'JWT_SECRET_KEY') }}
          PORT={{ lookup('env', 'PORT') }}
          RAZORPAY_SECRET_KEY={{ lookup('env', 'RAZORPAY_SECRET_KEY') }}
          RAZORPAY_KEY_ID={{ lookup('env', 'RAZORPAY_KEY_ID') }}
          RAZORPAY_WEBHOOK_SECRET={{ lookup('env', 'RAZORPAY_WEBHOOK_SECRET') }}
          CLOUD_NAME={{ lookup('env', 'CLOUD_NAME') }}
          API_KEY={{ lookup('env', 'API_KEY') }}
          API_SECRET={{ lookup('env', 'API_SECRET') }}

    - name: Install backend dependencies (ignore peer deps)
      become: false
      command: npm install --legacy-peer-deps
      args:
        chdir: /home/ubuntu/backend

    - name: Ensure PM2 is installed globally
      become: yes
      npm:
        name: pm2
        global: yes

    - name: Check if backend is already running
      become: false
      command: pm2 list
      register: pm2_list
      changed_when: false

    - name: Restart backend if already running
      become: false
      command: pm2 restart backend
      when: "'backend' in pm2_list.stdout"

    - name: Start backend if not running
      become: false
      command: pm2 start ./src/app.js --name backend
      args:
        chdir: /home/ubuntu/backend
      when: "'backend' not in pm2_list.stdout"

    - name: Save PM2 process list
      become: false
      command: pm2 save

    - name: Wait for backend to be healthy
      uri:
        url: http://127.0.0.1:7777/health
        method: GET
        status_code: 200
        timeout: 5
      register: backend_health
      retries: 10
      delay: 3
      until: backend_health.status == 200
